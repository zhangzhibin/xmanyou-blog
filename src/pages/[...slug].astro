---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => {
    const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
    return { params: { slug }, props: { entry } };
  });
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const isPage = entry.data.type === 'page';
const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
---

<Layout title={entry.data.title} description={entry.data.description} image={entry.data.image} canonicalSlug={slug}>
  {isPage ? (
    <main id="site-main" class="site-main">
      <article class="article page">
        <header class="article-header gh-canvas">
          <h1 class="article-title">{entry.data.title}</h1>
        </header>
        <section class="gh-content gh-canvas">
          <Content />
        </section>
      </article>
    </main>
  ) : (
    <main id="site-main" class="site-main">
      <article class="article post">
        <header class="article-header gh-canvas">
          {entry.data.tagSlugs?.length > 0 && (
            <div class="article-tag post-card-tags">
              <span class="post-card-primary-tag">
                <a href={`/tag/${entry.data.tagSlugs[0]}/`}>{entry.data.tags[0] ?? entry.data.tagSlugs[0]}</a>
              </span>
            </div>
          )}
          <h1 class="article-title">{entry.data.title}</h1>
          {entry.data.description && (
            <p class="article-excerpt">{entry.data.description}</p>
          )}
          <div class="article-byline">
            <section class="article-byline-content">
              <div class="article-byline-meta">
                <h4 class="author-name">
                  {entry.data.authorSlug ? (
                    <a href={`/author/${entry.data.authorSlug}/`}>{entry.data.author}</a>
                  ) : (
                    entry.data.author
                  )}
                </h4>
                <div class="byline-meta-content">
                  <time class="byline-meta-date" datetime={entry.data.pubDate.toISOString().slice(0, 10)}>
                    {entry.data.pubDate.toLocaleDateString('zh-CN')}
                  </time>
                </div>
              </div>
            </section>
          </div>
          {entry.data.image && (
            <figure class="article-image">
              <img src={entry.data.image} alt={entry.data.title} />
            </figure>
          )}
        </header>
        <section class="gh-content gh-canvas">
          <Content />
        </section>
      </article>
    </main>
  )}
</Layout>
