---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => {
    const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
    return { params: { slug }, props: { entry } };
  });
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const isPage = entry.data.type === 'page';
const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');

// 仅文章页：相关文章（同 tag 最近 6 篇 + 总数）、上一篇下一篇（仅按时间，仅含 post）
let tagLinks: { slug: string; label: string }[] = [];
let relatedByTag: typeof entry[] = [];
let totalRelatedCount = 0;
let prevEntry: typeof entry | null = null;
let nextEntry: typeof entry | null = null;
if (!isPage) {
  const allPosts = (await getCollection('blog', ({ data }) => !data.draft && data.type === 'post'))
    .sort((a, b) => (b.data.pubDate?.valueOf() ?? 0) - (a.data.pubDate?.valueOf() ?? 0));
  const currentIndex = allPosts.findIndex((p) => p.id === entry.id);
  if (currentIndex >= 0) {
    prevEntry = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
    nextEntry = currentIndex > 0 ? allPosts[currentIndex - 1] : null;
  }
  const tagSlugs = entry.data.tagSlugs ?? [];
  const tags = entry.data.tags ?? [];
  if (tagSlugs.length > 0) {
    tagLinks = tagSlugs.map((s, i) => ({ slug: s, label: tags[i] ?? s }));
    const sameTag = allPosts.filter(
      (p) => p.id !== entry.id && (p.data.tagSlugs ?? []).some((t) => tagSlugs.includes(t))
    );
    totalRelatedCount = sameTag.length;
    relatedByTag = sameTag.slice(0, 6);
  }
}

const toSlug = (e: typeof entry) => (e.data.slug || e.id || '').replace(/\.mdx?$/, '');
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.image}
  canonicalSlug={slug}
  ogType={isPage ? 'website' : 'article'}
  articlePublishedTime={!isPage && entry.data.pubDate ? entry.data.pubDate.toISOString() : undefined}
  articleAuthor={!isPage ? entry.data.author : undefined}
  articleTags={!isPage && entry.data.tags?.length ? entry.data.tags : undefined}
>
  {isPage ? (
    <main id="site-main" class="site-main page-template">
      <article class="article post">
        <header class="article-header gh-canvas">
          <h1 class="article-title">{entry.data.title}</h1>
        </header>
        <section class="gh-content gh-canvas">
          <Content />
        </section>
      </article>
    </main>
  ) : (
    <main id="site-main" class="site-main post-template">
      <article class="article post">
        <header class="article-header gh-canvas">
          {entry.data.tagSlugs?.length > 0 && (
            <div class="article-tag post-card-tags">
              {entry.data.tagSlugs.map((tagSlug, i) => (
                <span class="post-card-primary-tag">
                  <a href={`/tag/${tagSlug}/`}>{entry.data.tags?.[i] ?? tagSlug}</a>
                </span>
              ))}
            </div>
          )}
          <h1 class="article-title">{entry.data.title}</h1>
          {entry.data.description && (
            <p class="article-excerpt">{entry.data.description}</p>
          )}
          <div class="article-byline">
            <section class="article-byline-content">
              <div class="article-byline-meta">
                <h4 class="author-name">
                  {entry.data.authorSlug ? (
                    <a href={`/author/${entry.data.authorSlug}/`}>{entry.data.author}</a>
                  ) : (
                    entry.data.author
                  )}
                </h4>
                <div class="byline-meta-content">
                  <time class="byline-meta-date" datetime={entry.data.pubDate.toISOString().slice(0, 10)}>
                    {entry.data.pubDate.toLocaleDateString('zh-CN')}
                  </time>
                </div>
              </div>
            </section>
          </div>
          {entry.data.image && (
            <figure class="article-image">
              <img src={entry.data.image} alt={entry.data.title} />
            </figure>
          )}
        </header>
        <section class="gh-content gh-canvas">
          <Content />
        </section>
        <footer class="article-footer gh-canvas">
          <section class="article-footer-section article-footer-wechat" aria-label="微信公众号">
            <h3 class="article-footer-heading">扫一扫关注微信公众号：耿直的IT男阿斌</h3>
            <p class="article-footer-wechat-desc">聊一聊IT男眼中的世界</p>
            <a href="/about-us/" class="article-footer-wechat-qr-wrap" title="关注微信公众号：耿直的IT男阿斌">
              <img class="article-footer-wechat-qr" src="/wechat-official-qrcode.jpg" alt="微信公众号：耿直的IT男阿斌" width="200" height="200" />
            </a>
          </section>
          {(tagLinks.length > 0 || relatedByTag.length > 0) && (
            <section class="article-footer-section article-footer-tags" aria-label="相关文章">
              <h3 class="article-footer-heading">
                相关文章（
                {tagLinks.length > 0 ? (
                  tagLinks.map((t, i) => (
                    <>
                      {i > 0 && '、'}
                      <a href={`/tag/${t.slug}/`} class="article-footer-heading-tag">{t.label}</a>
                    </>
                  ))
                ) : (
                  'tag'
                )}
                ）
              </h3>
              {relatedByTag.length > 0 && (
                <>
                  <ul class="article-footer-related-list">
                    {relatedByTag.map((p) => (
                      <li><a href={`/${toSlug(p)}/`}>{p.data.title}</a></li>
                    ))}
                  </ul>
                  <p class="article-footer-related-total">共 {totalRelatedCount} 篇</p>
                </>
              )}
            </section>
          )}
          <section class="article-footer-section article-footer-nav" aria-label="上一篇下一篇">
            <div class="article-footer-prev-next">
              {prevEntry ? (
                <a href={`/${toSlug(prevEntry)}/`} class="article-footer-link article-footer-prev" rel="prev">上一篇：{prevEntry.data.title}</a>
              ) : (
                <span class="article-footer-link article-footer-prev disabled">上一篇</span>
              )}
              {nextEntry ? (
                <a href={`/${toSlug(nextEntry)}/`} class="article-footer-link article-footer-next" rel="next">下一篇：{nextEntry.data.title}</a>
              ) : (
                <span class="article-footer-link article-footer-next disabled">下一篇</span>
              )}
            </div>
          </section>
        </footer>
      </article>
    </main>
  )}
</Layout>
