---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('blog', ({ data }) => !data.draft);
  return entries.map((entry) => {
    const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
    return { params: { slug }, props: { entry } };
  });
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const isPage = entry.data.type === 'page';
const slug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
---

<Layout title={entry.data.title} description={entry.data.description} image={entry.data.image} canonicalSlug={slug}>
  <article class={isPage ? 'page' : 'post'}>
    <header>
      <h1>{entry.data.title}</h1>
      {!isPage && (
        <p>
          {entry.data.authorSlug ? (
            <a href={`/author/${entry.data.authorSlug}/`}>{entry.data.author}</a>
          ) : (
            <span>{entry.data.author}</span>
          )}
          <time datetime={entry.data.pubDate.toISOString()}>
            {entry.data.pubDate.toLocaleDateString('zh-CN')}
          </time>
        </p>
      )}
      {!isPage && entry.data.tagSlugs?.length > 0 && (
        <ul>
          {entry.data.tagSlugs.map((tagSlug, i) => (
            <li><a href={`/tag/${tagSlug}/`}>{entry.data.tags[i] ?? tagSlug}</a></li>
          ))}
        </ul>
      )}
    </header>
    {entry.data.image && (
      <img src={entry.data.image} alt="" />
    )}
    <div class="content">
      <Content />
    </div>
  </article>
</Layout>
