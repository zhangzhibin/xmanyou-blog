---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft && data.type === 'post' && (data.tagSlugs?.length ?? 0) > 0);
  const slugSet = new Set<string>();
  for (const p of posts) {
    for (const s of p.data.tagSlugs ?? []) slugSet.add(s);
  }
  return Array.from(slugSet).map((slug) => ({
    params: { slug },
    props: { slug },
  }));
}

const { slug } = Astro.props;
const posts = (await getCollection('blog', ({ data }) => !data.draft && data.type === 'post' && (data.tagSlugs ?? []).includes(slug)))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const tagName = posts[0] ? (() => {
  const idx = posts[0].data.tagSlugs?.indexOf(slug) ?? -1;
  return idx >= 0 ? (posts[0].data.tags[idx] ?? slug) : slug;
})() : slug;
---

<Layout title={`${tagName} - 厦门暗游网络科技有限公司`} description={`标签 ${tagName} 的文章列表`}>
  <article class="tag-page">
    <header>
      <h1>{tagName}</h1>
    </header>
    <ul>
      {posts.map((entry) => {
        const postSlug = (entry.data.slug || entry.id || '').replace(/\.mdx?$/, '');
        const primaryTag = entry.data.tags[0] ?? entry.data.tagSlugs[0] ?? '';
        return (
          <li>
            <a href={`/${postSlug}/`}>
              {primaryTag && primaryTag !== tagName ? `[${primaryTag} ${entry.data.title}]` : entry.data.title}
            </a>
          </li>
        );
      })}
    </ul>
  </article>
</Layout>
